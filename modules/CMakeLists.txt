set(LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/lib/)
set(EXECUTABLE_OUTPUT_PATH ${PROJECT_BINARY_DIR}/bin/)

set(CNSTREAM_TARGET_SOVERSION 4)
set(CNSTREAM_TARGET_VERSION 4.4)
add_definitions(-DCNSTREAM_VERSION=${CNSTREAM_TARGET_VERSION})

include_directories(${PROJECT_SOURCE_DIR}/3rdparty/googletest/include/)
include_directories(${3RDPARTY_INCLUDE_DIRS})

set(module_list core)
if(build_ipc)
  list(APPEND module_list ipc)
endif()
if(build_encode)
  list(APPEND module_list encode)
endif()
if(build_inference)
  list(APPEND module_list inference)
endif()
if(build_osd)
  list(APPEND module_list osd)
endif()
if(build_rtsp_sink)
  list(APPEND module_list rtsp_sink)
endif()
if(build_source)
  list(APPEND module_list source)
endif()
if(build_track)
  list(APPEND module_list track)
endif()

list(APPEND module_list display)

if(HAVE_FFMPEG)
  include_directories(${FFMPEG_INCLUDE_DIR})
endif()
include_directories(${OpenCV_INCLUDE_DIRS})

#FIXME
set(SOURCE_LINKER_LIBS dl ${CN_LIBS} ${3RDPARTY_LIBS} ${OpenCV_LIBS} ${SDL2_LIBRARIES} ${FFMPEG_LIBRARIES} pthread)
  
foreach(module ${module_list})
  include_directories(${PROJECT_SOURCE_DIR}/modules/${module}/include)
  file(GLOB_RECURSE module_src ${PROJECT_SOURCE_DIR}/modules/${module}/*.cpp)
  list(APPEND srcs ${module_src})
  if(module STREQUAL "rtsp_sink")
    set(Live555_LIBS "")
    if(HAVE_FFMPEG)
      include_directories(${FFMPEG_INCLUDE_DIR})
    endif()
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wno-deprecated-declarations")
    include_directories(${PROJECT_SOURCE_DIR}/3rdparty/live555/include/BasicUsageEnvironment)
    install(DIRECTORY ${PROJECT_SOURCE_DIR}/3rdparty/live555/include/BasicUsageEnvironment/ DESTINATION include)
    include_directories(${PROJECT_SOURCE_DIR}/3rdparty/live555/include/groupsock)
    install(DIRECTORY ${PROJECT_SOURCE_DIR}/3rdparty/live555/include/groupsock/ DESTINATION include)
    include_directories(${PROJECT_SOURCE_DIR}/3rdparty/live555/include/liveMedia)
    install(DIRECTORY ${PROJECT_SOURCE_DIR}/3rdparty/live555/include/liveMedia/ DESTINATION include)
    include_directories(${PROJECT_SOURCE_DIR}/3rdparty/live555/include/UsageEnvironment)
    install(DIRECTORY ${PROJECT_SOURCE_DIR}/3rdparty/live555/include/UsageEnvironment/ DESTINATION include)
    include_directories(${PROJECT_SOURCE_DIR}/modules_contrib/${contrib_module}/)
    link_directories(${PROJECT_SOURCE_DIR}/3rdparty/live555/lib)
    set(Live555_LIBS liveMedia UsageEnvironment BasicUsageEnvironment groupsock)
  endif()
endforeach()

add_library(cnstream SHARED ${srcs})

if (SANITIZE_MEMORY OR SANITIZE_ADDRESS OR SANITIZE_THREAD OR SANITIZE_UNDEFINED)
    add_sanitizers(cnstream)
endif()

install(TARGETS cnstream LIBRARY DESTINATION lib)
target_link_libraries(cnstream ${SOURCE_LINKER_LIBS} ${Live555_LIBS})
set_target_properties(cnstream PROPERTIES VERSION ${CNSTREAM_TARGET_VERSION} SOVERSION ${CNSTREAM_TARGET_SOVERSION})
install(DIRECTORY core/include/ DESTINATION include)

if(NOT Live555_LIBS STREQUAL "")
  set_directory_properties(PROPERTIES ADDITIONAL_MAKE_CLEAN_FILES ${PROJECT_SOURCE_DIR}/3rdparty/live555)
  add_custom_target(live555 sh ${PROJECT_SOURCE_DIR}/tools/build_live555.sh)
  add_dependencies(cnstream live555)
endif()

if(build_tests)
  add_subdirectory(unitest)
endif()
