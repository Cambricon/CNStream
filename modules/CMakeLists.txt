set(LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/lib/)
set(EXECUTABLE_OUTPUT_PATH ${PROJECT_BINARY_DIR}/bin/)
set(CNSTREAM_TARGET_SOVERSION 4)
set(CNSTREAM_TARGET_VERSION 4.0)
add_definitions(-DCNSTREAM_VERSION=${CNSTREAM_TARGET_VERSION})

include_directories(${PROJECT_SOURCE_DIR}/3rdparty/deepsort/include)
include_directories(${PROJECT_SOURCE_DIR}/3rdparty/googletest/include/)

set(module_list core inference encode source osd track display)

find_package(OpenCV REQUIRED)

if(cnstream_build_integrated_lib)
  if(HAVE_FFMPEG)
    include_directories(${FFMPEG_INCLUDE_DIR})
  endif()
  foreach(module ${module_list})
    include_directories(${PROJECT_SOURCE_DIR}/modules/${module}/include)
    file(GLOB_RECURSE module_src ${PROJECT_SOURCE_DIR}/modules/${module}/*.cpp)
    list(APPEND srcs ${module_src})
  endforeach()
  add_library(cnstream SHARED ${srcs})
  include_directories(${OpenCV_INCLUDE_DIRS})
  target_link_libraries(cnstream cnbase cnpreproc cnpostproc cndecode cninfer cnosd cncodec cnrt cntrack deepsort ${OpenCV_LIBS} ${SOURCE_LINKER_LIBS})
  set_target_properties(cnstream PROPERTIES VERSION ${CNSTREAM_TARGET_VERSION} SOVERSION ${CNSTREAM_TARGET_SOVERSION})
else()
  add_subdirectory(core)
  add_subdirectory(source)
  add_subdirectory(inference)
  add_subdirectory(osd)
  add_subdirectory(encode)
  add_subdirectory(track)
  add_subdirectory(display)
endif()

if(cnstream_build_tests)
  add_subdirectory(unitest)
endif()
